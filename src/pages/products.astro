---
import BaseLayout from "../layouts/BaseLayout.astro";
import * as fs from "fs";
import * as path from "path";
import Papa from "papaparse";

const csvPath = path.resolve("./src/data/products.csv");
const csv = fs.readFileSync(csvPath, "utf8");
const { data: products } = Papa.parse(csv, { header: true });
---

<BaseLayout>
  <main class="min-h-screen bg-slate-900 text-slate-100 flex flex-col items-center py-16">
    <h1 class="text-4xl font-extrabold mb-8">Our Products</h1>
    <div class="w-full max-w-6xl mb-8 flex flex-col sm:flex-row gap-4 items-center justify-between">
      <div class="flex gap-2 w-full sm:w-auto">
        <input id="filter-input" type="text" placeholder="Filter by title..." class="px-4 py-2 rounded bg-slate-800 border border-slate-700 text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-64" />
      </div>
      <div class="flex gap-2 w-full sm:w-auto">
        <label for="sort-select" class="sr-only">Sort by</label>
        <select id="sort-select" class="px-4 py-2 rounded bg-slate-800 border border-slate-700 text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="name-asc">Name (A-Z)</option>
          <option value="name-desc">Name (Z-A)</option>
          <option value="price-asc">Price (Low-High)</option>
          <option value="price-desc">Price (High-Low)</option>
        </select>
      </div>
    </div>
    <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 w-full max-w-6xl">
      {products.filter(p => p.title && p.image).map((product, i) => (
        <div class="bg-slate-800 rounded-2xl shadow-lg p-6 flex flex-col items-center product-card" 
             data-title={product.title} 
             data-price={parseFloat((product.price||'').replace(/[^\d.]/g, '')) || 0}
             data-index={i}>
          <img src={product.image} alt={product.title} class="w-full h-48 object-cover rounded-xl mb-4 border border-slate-700" loading="lazy" />
          <div class="w-full flex flex-col items-start">
            <h2 class="text-xl font-bold text-slate-100 mb-1">{product.title}</h2>
            <p class="text-slate-400 mb-2">{product.subtitle || ""}</p>
            <span class="text-lg font-semibold text-cyan-400">{product.price || ""}</span>
            <a href={`/products/${i}`} class="mt-4 inline-block px-6 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 transition">View Details</a>
          </div>
        </div>
      ))}
    </div>
  </main>
  <script>
    const filterInput = document.getElementById('filter-input');
    const sortSelect = document.getElementById('sort-select');
    const grid = document.getElementById('products-grid');
    let cards = Array.from(grid.children);

    function renderCards(newOrder) {
      grid.innerHTML = '';
      newOrder.forEach(card => grid.appendChild(card));
    }

    function filterAndSort() {
      let filtered = cards;
      const filter = filterInput.value.trim().toLowerCase();
      if (filter) {
        filtered = filtered.filter(card => card.dataset.title.toLowerCase().includes(filter));
      }
      const sort = sortSelect.value;
      if (sort === 'name-asc') {
        filtered.sort((a, b) => a.dataset.title.localeCompare(b.dataset.title));
      } else if (sort === 'name-desc') {
        filtered.sort((a, b) => b.dataset.title.localeCompare(a.dataset.title));
      } else if (sort === 'price-asc') {
        filtered.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
      } else if (sort === 'price-desc') {
        filtered.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
      }
      renderCards(filtered);
    }

    filterInput.addEventListener('input', filterAndSort);
    sortSelect.addEventListener('change', filterAndSort);
    // Initial sort
    filterAndSort();
  </script>
</BaseLayout> 